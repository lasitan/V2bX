name: Docker Build Binary and Upload Release

on:
  workflow_dispatch:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  build-binaries:
    runs-on: [self-hosted, Linux, ARM64]
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: linux/amd64
            asset_arch: "64"
          - platform: linux/arm64
            asset_arch: "arm64-v8a"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build builder stage and export
        uses: docker/build-push-action@v6
        with:
          context: .
          target: builder
          platforms: ${{ matrix.platform }}
          outputs: type=local,dest=dist/${{ matrix.platform }}

      - name: Package release zip
        run: |
          set -euo pipefail
          mkdir -p release_out
          bin_path="dist/${{ matrix.platform }}/V2bX"
          if [ ! -f "${bin_path}" ]; then
            bin_path="dist/${{ matrix.platform }}/app/V2bX"
          fi
          if [ ! -f "${bin_path}" ]; then
            echo "V2bX binary not found under dist/${{ matrix.platform }}" >&2
            find "dist/${{ matrix.platform }}" -maxdepth 4 -type f -print || true
            exit 1
          fi
          work_dir="work/${{ matrix.platform }}"
          rm -rf "${work_dir}"
          mkdir -p "${work_dir}"

          cp "${bin_path}" "${work_dir}/V2bX"
          chmod +x "${work_dir}/V2bX"

          cp "example/config.json" "${work_dir}/config.json"
          cp "example/dns.json" "${work_dir}/dns.json"
          cp "example/route.json" "${work_dir}/route.json"
          cp "example/custom_outbound.json" "${work_dir}/custom_outbound.json"
          cp "example/custom_inbound.json" "${work_dir}/custom_inbound.json"

          curl -fsSL "https://raw.githubusercontent.com/Loyalsoldier/v2ray-rules-dat/release/geoip.dat" -o "${work_dir}/geoip.dat"
          curl -fsSL "https://raw.githubusercontent.com/Loyalsoldier/v2ray-rules-dat/release/geosite.dat" -o "${work_dir}/geosite.dat"

          pkg="V2bX-linux-${{ matrix.asset_arch }}.zip"
          (cd "${work_dir}" && zip -9r "${GITHUB_WORKSPACE}/release_out/${pkg}" .)

      - name: Upload binaries to release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: release_out/*
          tag: ${{ github.ref }}
          file_glob: true
